#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Intelligent Universal Launcher
# =============================================================================
# Script: steamos-session-launch
# Version: 3.6.0
# Description: Minimal environment with ACTIVE recovery watchdog.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
## Path:        /usr/local/bin/steamos-session-launch
# License: MIT
# =========================================================
# =============================================================================
set -eou pipefail

# --- 1. CONFIGURATION & AGNOSTIC ENVIRONMENT ---
GLOBAL_CONFIG="/etc/default/steamos-diy"
CURRENT_UID=$(id -u)
export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${CURRENT_UID}/bus"

if [[ -f "$GLOBAL_CONFIG" ]]; then
    set -a
    source "$GLOBAL_CONFIG"
    set +a
else
    echo "[ERROR] Global configuration not found at $GLOBAL_CONFIG"
    exit 1
fi

readonly LOG_FILE="${LOG_FILE:-/var/log/steamos-diy.log}"
readonly STEAM_LOG_PATH="${STEAM_LOG:-$HOME/.local/share/Steam/logs/console-linux.txt}"
readonly CONFIG_FILE="${CONF_DIR:-$HOME/.config/steamos-diy}/config"

log() {
    local tag="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ${LOG_TAG:-[SteamOS-DIY]} [$tag] $msg" >> "$LOG_FILE" 2>/dev/null || true
}

# --- GRACEFUL SHUTDOWN (SIGTERM) ---
cleanup_session() {
    log "EXIT" "Termination signal received. Initiating graceful shutdown..."
    if [[ -n "${G_PID:-}" ]]; then
        kill -TERM "$G_PID" 2>/dev/null || true
    fi
    local timeout=3
    while [ $timeout -gt 0 ] && pgrep -x "gamescope" > /dev/null; do
        sleep 1
        ((timeout--))
    done
    log "EXIT" "All processes synchronized and closed. Session ended."
    exit 0
}

trap cleanup_session SIGINT SIGTERM

echo "========================================" >> "$LOG_FILE"
log "INIT" "New session initiated for user: $USER (UID: $CURRENT_UID)"

# --- 2. HARDWARE DETECTION ---
DRM_CONN=$(grep -l "^connected" /sys/class/drm/card*-*/status | head -n1 || true)
DRM_PATH=$(dirname "$DRM_CONN")
NATIVE_RES=$(head -n1 "$DRM_PATH/modes" 2>/dev/null || echo "1280x720")
HW_W=${NATIVE_RES%x*}
HW_H=${NATIVE_RES#*x}

# --- 3. LOCAL USER CONFIGURATION ---
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# --- 4. DYNAMIC ARGUMENTS CONSTRUCTION & SAFETY CAP ---
G_OPTS=("${G_OPTS_BASE:--e}")
FINAL_W=${TARGET_WIDTH:-$HW_W}
FINAL_H=${TARGET_HEIGHT:-$HW_H}
FINAL_R=${REFRESH_RATE:-60}

# [From 3.1.0]: Safety Cap - Prevent resolution exceeding hardware
if [ "$FINAL_W" -gt "$HW_W" ] || [ "$FINAL_H" -gt "$HW_H" ]; then
    log "WARN" "Requested ${FINAL_W}x${FINAL_H} exceeds hardware. Capping to native."
    FINAL_W=$HW_W; FINAL_H=$HW_H; FINAL_R=60
fi

G_OPTS+=("-W" "$FINAL_W" "-H" "$FINAL_H" "-r" "$FINAL_R")

# Feature Toggles
[[ "${ENABLE_HDR:-0}" == "1" ]] && G_OPTS+=("--hdr-enabled")
[[ "${ENABLE_VRR:-0}" == "1" ]] && G_OPTS+=("--adaptive-sync")
[[ "${ENABLE_MANGOAPP:-0}" == "1" ]] && G_OPTS+=("--mangoapp")

# [From 3.1.0]: Support for manual Extra Args
if [[ -n "${GAMESCOPE_ARGS:-}" ]]; then
    read -r -a EXTRA <<< "$GAMESCOPE_ARGS"
    G_OPTS+=("${EXTRA[@]}")
fi

log "LAUNCH" "Gamescope OPTS: ${G_OPTS[*]}"

# --- 5. EXECUTION & WATCHDOG ---
START_TIME=$(date +%s)
G_EXIT_CODE=0

# [From 3.5.2]: Background execution with PID monitoring
stdbuf -oL -eL gamescope "${G_OPTS[@]}" -- \
    steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1 &

G_PID=$!
# Trigger per comandi post-inizializzazione (es. VRR Fix)
if [[ -n "${POST_LAUNCH_CMD:-}" ]]; then
    log "POST" "Scheduling post-launch command: $POST_LAUNCH_CMD"
    (sleep 5; eval "$POST_LAUNCH_CMD" >> "$LOG_FILE" 2>&1) &
fi
wait "$G_PID" || G_EXIT_CODE=$?

RUNTIME=$(( $(date +%s) - START_TIME ))

# LOGICA DI RECOVERY
if [ "$G_EXIT_CODE" -ne 0 ] && [ "$RUNTIME" -lt 10 ]; then
    log "CRITICAL" "Early crash detected after ${RUNTIME}s. RECOVERING..."

    # [From 3.5.2]: Forced cleanup before recovery launch
    pgrep -x "gamescope" | xargs kill -9 2>/dev/null || true

    log "RECOVERY" "Launching Safe Mode at ${HW_W}x${HW_H}@60Hz"
    stdbuf -oL -eL gamescope -e -W "$HW_W" -H "$HW_H" -r 60 -- \
        steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1 || G_EXIT_CODE=$?
else
    log "EXIT" "Session finished naturally. Exit code: $G_EXIT_CODE"
fi

# --- 6. STEAM ERROR EXTRACTOR (SDY Marker) ---
# [From 3.1.0]: Extract context if the session failed
if [ "$G_EXIT_CODE" -ne 0 ]; then
    if [[ -f "$STEAM_LOG_PATH" ]]; then
        LAST_START_MARKER=$(grep -a "SDY_REATTIVO_START" "$STEAM_LOG_PATH" | tail -n 1 || true)
        if [[ -n "$LAST_START_MARKER" ]]; then
            log "STEAM_ERR" ">>> Extracting diagnostic context from Steam Log <<<"
            grep -a -F -A 30 "$LAST_START_MARKER" "$STEAM_LOG_PATH" >> "$LOG_FILE" || true
        fi
    fi
fi

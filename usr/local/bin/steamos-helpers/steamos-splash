#!/bin/bash
# =============================================================================
# SteamMachine-DIY - steamos-splash (v4.0.0)
# =============================================================================
set -uo pipefail

# --- 1. CONFIGURAZIONE & SSoT ---
# Usiamo il percorso blindato che abbiamo definito nel Master
GLOBAL_CONF="/etc/default/steamos-diy"
[ -f "$GLOBAL_CONF" ] && source "$GLOBAL_CONF"

# Recuperiamo SYSTEM_NAME dal Master (se manca, fallback a SteamOS-DIY)
SYSTEM_NAME="${SYSTEM_NAME:-SteamOS-DIY}"
# Ritardi ereditati (ora configurabili dall'utente o dal master)
DELAY_SHORT="${SPLASH_DELAY_SHORT:-1.0}"
DELAY_LONG="${SPLASH_DELAY_LONG:-2.5}"
LOCK_FILE="/run/steamos-splash.pid"

# --- 2. GESTIONE LOCK ---
if [[ -f "$LOCK_FILE" ]]; then
    OLD_PID=$(cat "$LOCK_FILE" 2>/dev/null)
    if [[ -n "$OLD_PID" ]] && kill -0 "$OLD_PID" 2>/dev/null; then
        exit 0 
    fi
fi
echo $$ > "$LOCK_FILE" 2>/dev/null || true

# --- 3. FORZATURA TTY & RESET ---
# Non cambiamo terminale se siamo in fase di spegnimento profondo
if ! [[ "${1:-}" =~ ^(reboot|poweroff|halt)$ ]]; then
    /usr/bin/chvt 1 2>/dev/null || true
fi

# Reset schermo e nascondi cursore
echo -ne "\033c" > /dev/tty1
setterm -cursor off > /dev/tty1 || true

# --- 4. LOGICA DEGLI STATI ---
CYAN='\e[1;36m'; GREEN='\e[1;32m'; RED='\e[1;31m'; YELLOW='\e[1;33m'
WHITE='\e[1;37m'; GRAY='\e[1;30m'; RESET='\e[0m'

MODE_ARG="${1:-auto}"

case "$MODE_ARG" in
    "game")     
        COLOR=$GREEN;  MODE="Game Mode";    STAT="Launching..."; DELAY=$DELAY_SHORT ;;
    "desktop")  
        COLOR=$CYAN;   MODE="Desktop Mode"; STAT="Switching..."; DELAY=$DELAY_SHORT ;;
    "reboot")
        COLOR=$YELLOW; MODE="System";       STAT="Rebooting..."; DELAY=$DELAY_LONG ;;
    "poweroff"|"halt")
        COLOR=$RED;    MODE="System";       STAT="Shutting down..."; DELAY=$DELAY_LONG ;;
    *)
        # AUTO-RILEVAMENTO (Importante per ExecStopPost dove non passiamo argomenti)
        if systemctl list-jobs 2>/dev/null | grep -q "reboot.target"; then
            COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=$DELAY_LONG
        elif systemctl list-jobs 2>/dev/null | grep -qE "shutdown.target|poweroff.target|halt.target"; then
            COLOR=$RED;    MODE="System"; STAT="Shutting down..."; DELAY=$DELAY_LONG
        else
            # Se chiamato senza argomenti e non è spegnimento, puliamo e usciamo (TOTAL BLACK)
            rm -f "$LOCK_FILE" 2>/dev/null || true
            exit 0
        fi
        ;;
esac

# --- 5. RENDERING ADATTIVO ---
# Rilevamento geometria TTY1
COLUMNS=$(tput -T linux cols 2>/dev/null || echo 80)
LINES=$(tput -T linux lines 2>/dev/null || echo 24)

# Calcolo centering (Logo 12x5 circa)
OFFSET_X=$(( (COLUMNS - 52) / 2 ))
OFFSET_Y=$(( (LINES - 5) / 2 ))

[ $OFFSET_X -lt 0 ] && OFFSET_X=0
[ $OFFSET_Y -lt 0 ] && OFFSET_Y=0

PADDING_Y=""; for ((i=0; i<OFFSET_Y; i++)); do PADDING_Y+="\n"; done
PAD_X="";     for ((i=0; i<OFFSET_X; i++)); do PAD_X+=" "; done

OUT="${PADDING_Y}"
OUT+="${PAD_X}${COLOR}   ◢██████◣   ${RESET}   ${COLOR}◢◤ ${WHITE}${SYSTEM_NAME}${RESET}\n"
OUT+="${PAD_X}${COLOR}  ██◤    ◥██  ${RESET}   ${GRAY}━━━━━━━━━━━━━━━━━━━━━━━${RESET}\n"
OUT+="${PAD_X}${COLOR}  ██        ██  ${RESET}   ${GRAY}Powered by KISS${RESET}\n"
OUT+="${PAD_X}${COLOR}  ██◣    ◢██  ${RESET}   ${WHITE}MODE   : ${COLOR}${MODE}${RESET}\n"
OUT+="${PAD_X}${COLOR}   ◥██████◤   ${RESET}   ${WHITE}STATUS : ${GRAY}${STAT}${RESET}\n"

echo -ne "$OUT" > /dev/tty1

# --- 6. CHIUSURA ---
if [[ "$MODE_ARG" =~ ^(reboot|poweroff|halt)$ ]]; then
    # Lasciamo l'output sulla TTY durante lo shutdown
    exit 0
fi

sleep "${DELAY}"
rm -f "$LOCK_FILE" 2>/dev/null || true

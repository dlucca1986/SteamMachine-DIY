#!/bin/bash
# ==============================================================================
# SteamOS-DIY Boot Splash System
# Version: 3.1.0
# Description: Minimalist TTY1 splash screen for session transitions.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path:        /usr/local/bin/steamos-helpers/steamos-splash
# License: MIT
# ==============================================================================

# --- Configuration & Environment ---
GLOBAL_CONF="/etc/default/steamos-diy"
[ -f "$GLOBAL_CONF" ] && source "$GLOBAL_CONF"

# Default fallback values
DISPLAY_USER="${STEAMOS_USER:-User}"
LOCK_FILE="/tmp/steamos-splash.lock"

# --- TTY Output Function (Native) ---
# Poiché il .service ha StandardOutput=tty, stampiamo direttamente
tty_out() {
    echo -ne "$1"
}

# --- Initialization ---
# Reset hardware e nascondi cursore (ora senza sudo e senza permessi negati)
tty_out '\033c'
setterm -cursor off 2>/dev/null || true

# --- UI Color Definitions (ANSI) ---
CYAN='\e[1;36m'; GREEN='\e[1;32m'; RED='\e[1;31m'; YELLOW='\e[1;33m'; WHITE='\e[1;37m'; GRAY='\e[1;30m'; RESET='\e[0m'
PAD="            "

# --- Argument & State Logic ---
case "$1" in
    "game")     rm -f "$LOCK_FILE" 2>/dev/null; COLOR=$GREEN; MODE="Game Mode"; STAT="Active"; DELAY=0.5 ;;
    "desktop")  rm -f "$LOCK_FILE" 2>/dev/null; COLOR=$CYAN; MODE="Desktop Mode"; STAT="Online"; DELAY=0.5 ;;
    "reboot")   COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=1.0 ;;
    "shutdown") COLOR=$RED; MODE="System"; STAT="Shutting down..."; DELAY=1.0 ;;
    *)
        if systemctl list-jobs | grep -q "reboot.target"; then
            COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=2.5
        elif systemctl list-jobs | grep -qE "shutdown.target|poweroff.target|halt.target"; then
            COLOR=$RED; MODE="System"; STAT="Shutting down..."; DELAY=2.5
        else
            [[ -f "$LOCK_FILE" ]] && exit 0
            COLOR=$WHITE; MODE="Wait"; STAT="Processing..."; DELAY=0.5
        fi
        ;;
esac

# --- Screen Rendering ---
OUT="\n\n\n\n\n\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}${DISPLAY_USER}${RESET}@${WHITE}steamos-diy${RESET}\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${GRAY}-------------------${RESET}\n"
OUT+="${PAD}${COLOR}  ◢◤          ◢◤  ${RESET}   ${WHITE}Os     : SteamOS-DIY\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${WHITE}Mode   : ${COLOR}${MODE}${RESET}\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}Status : ${GRAY}${STAT}${RESET}\n"

tty_out "$OUT"

# Mantiene lo splash visibile per il tempo definito
sleep $DELAY
